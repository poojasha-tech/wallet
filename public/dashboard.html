<!-- wallet, deposit, download statement -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to your Digital Dashboard</title>
    <title>Statement Generator</title>
</head>
<style>
    body {
        font-family: Arial, Helvetica, sans-serif;
        margin: 0;
        padding: 0;
        background: #f3f4f6;
    }

    .container {
        max-width: 900px;
        margin: 20px auto;
        padding: 10px;
    }

    .card {
        background: white;
        padding: 16px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }

    .selectRange {
        margin: 12px 0;
    }

    input {
        width: 100%;
        padding: 8px;
        margin: 8px 0;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    button {
        padding: 8px 20px;
        border-radius: 6px;
        margin: 4px;
        border: 1px solid olivedrab;
        background: #2563eb;
        color: #fff;
        cursor: pointer;
    }

    .msg {
        margin-top: 8px;
        color: #b91c1c;
    }


    header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 20px;
        background: #111827;
        color: #fff;
    }
</style>

<body>
    <header>
        <h1>Welcome to Your Digital Dashboard</h1>
    </header>

    <div class="container">
        <div class="card">
            <h2>Your Wallet</h2>
            <div>Your wallet balance is <span id="balance-display">-</span></div>
            <h3>Generate Statement</h3>

            <label>Start Date:</label>
            <input type="date" id="startDate" />

            <label>End Date:</label>
            <input type="date" id="endDate" />

            <button id="downloadStatement">Download Statement</button>
            <p id="downloadStatementStatus"></p>

            <button id="viewStatement">View Statement</button>
            <p id="viewStatementStatus"></p>



            <div>
                <h3>Send Money</h3>

                <label>Receiver Account Number:</label>
                <input type="number" id="receiverAccountNumber" placeholder="Enter account number" />

                <label>Amount:</label>
                <input type="number" id="amount" placeholder="Enter amount" min="1" />

                <button id="transferBtn">Transfer</button>

                <p id="transferStatus"></p>

            </div>
            <div>
                <button id="logoutBtn">Logout</button>
            </div>
        </div>
        <script>
            async function init() {
                const requestOptions = {
                    method: 'GET',
                    headers: {
                        "Authorization": "Bearer " + localStorage.getItem("AUTH_API"),
                        "Content-Type": "application/json"
                    }

                };
                try {
                    const response = await fetch('http://localhost:3000/api/wallet/balance', requestOptions);
                    const data = await response.json();
                    if (Number(data.balance) < 100) {
                        document.getElementById("balance-display").style.color = "red";
                    }
                    else {
                        document.getElementById("balance-display").style.color = "green";
                    }
                    document.getElementById("balance-display").textContent = data.balance;
                }
                catch (error) {
                    console.error('Error fetching wallet balance:', error);
                    throw error; // rethrow to be caught by the outer catch
                }
            }
            // when page loads initilazie js
            window.addEventListener("DOMContentLoaded", async () => {
                await init()
            });




            //download statement
            const downloadButton = document.getElementById('downloadStatement');
            downloadButton.addEventListener('click', async () => {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const downloadStatus = document.getElementById('downloadStatementStatus');

                if (!startDate || !endDate) {
                    downloadStatus.textContent = 'Please select both start and end dates.';
                    downloadStatus.style.color = 'red';
                    return;
                }

                try {
                    const requestOptions = {
                        method: 'GET',
                        mode: 'cors',
                        headers: {
                            "Authorization": "Bearer " + localStorage.getItem("AUTH_API")
                        }
                    };

                    const response = await fetch(`http://localhost:3000/api/statement?startDate=${startDate}&endDate=${endDate}`, requestOptions);
                    if (!response.ok) {
                        throw new Error('Failed to generate statement');
                    }
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = "statement.csv";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                } catch (error) {
                    console.error('Error downloading statement:', error);
                    alert('An error occurred while downloading the statement. Please try again.');
                }
            });


            //view statement
            document.getElementById('viewStatement').addEventListener('click', () => {
                const start= document.getElementById('startDate').value;
                const end = document.getElementById('endDate').value;
                const viewStatus = document.getElementById('viewStatementStatus');

                if (!start || !end) {
                    viewStatus.textContent = 'Please select both start and end dates.';
                    viewStatus.style.color = 'red';
                    return;
                }

                // Open the statement in a new tab
                window.location.href = `viewTransactions.html?startDate=${start}&endDate=${end}`;
            });



            // transfer money
            
            const transferBtn = document.getElementById('transferBtn');
            transferBtn.addEventListener('click', async () => {
                const receiverAccountNumber = document.getElementById('receiverAccountNumber').value;
                const amount = document.getElementById('amount').value;
                const transferStatus = document.getElementById('transferStatus');   
                if (!receiverAccountNumber || !amount) {
                    transferStatus.textContent = 'Please enter both receiver account number and amount.';
                    transferStatus.style.color = 'red';
                    return;
                }

                // show transfer button as transfering
                transferBtn.textContent = 'Transferring...';
                transferBtn.disabled = true;

                try {
                    const requestOptions = {
                        method: 'POST',
                        headers: {
                            "Authorization": "Bearer " + localStorage.getItem("AUTH_API"),
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                           receiverAccountNumber: Number(receiverAccountNumber),
                            amount: Number(amount)
                        })
                    };  
                    const response = await fetch('http://localhost:3000/api/transfer', requestOptions);
                    const data = await response.json();
                    if (response.ok) {
                        transferStatus.textContent = 'Transfer successful!';
                        transferStatus.style.color = 'green';
                        // Update balance after successful transfer
                        await init();
                        window.location.href=`transfer-success.html?walletId=${data.senderWalletId}`;
                    
                    } 
                    else {
                        transferStatus.textContent = data.message || 'Transfer failed. Please try again.';
                        transferStatus.style.color = 'red';
                    }
                    


                } catch (error) {
                    console.error('Error during transfer:', error);
                    transferStatus.textContent = 'An error occurred during the transfer. Please try again.';
                    transferStatus.style.color = 'red';
                }
                finally {
                    transferBtn.textContent = 'Transfer';
                    transferBtn.disabled = false;
                }
            });


            //logout buttotn
            document.addEventListener("DOMContentLoaded",()=>{
                const logoutBtn = document.getElementById("logoutBtn");
                logoutBtn.addEventListener("click",()=>{
                    localStorage.removeItem("AUTH_API");
                    window.location.href = "index.html";
                })
            })



        
        </script>
    </div>

</body>

</html>